/* eslint-disable no-console */

const fs = require('fs')
const path = require('path')
const solc = require('solc')

const CONTRACT_FILE = path.join(__dirname, '..', 'contracts', 'MintOnce721.sol')
const outFile = path.join(__dirname, '..', 'src', 'bytecode', 'mintOnce721Bytecode.ts')

const source = fs.readFileSync(CONTRACT_FILE, 'utf8')

const input = {
  language: 'Solidity',
  sources: {
    'MintOnce721.sol': { content: source },
  },
  settings: {
    optimizer: { enabled: true, runs: 200 },
    outputSelection: {
      '*': {
        '*': ['evm.bytecode.object'],
      },
    },
  },
}

const output = JSON.parse(solc.compile(JSON.stringify(input)))

const errors = (output.errors || []).filter((e) => e.severity === 'error')
if (errors.length) {
  console.error(errors)
  process.exit(1)
}

const bytecode = output.contracts['MintOnce721.sol']['MintOnce721'].evm.bytecode.object
if (!bytecode || typeof bytecode !== 'string') {
  throw new Error('Failed to compile MintOnce721 bytecode')
}

fs.mkdirSync(path.dirname(outFile), { recursive: true })
fs.writeFileSync(
  outFile,
  `// AUTO-GENERATED by scripts/compile-contracts.cjs
// Do not edit by hand.
export const MINT_ONCE_721_BYTECODE = "0x${bytecode}" as const;
`,
  'utf8'
)

console.log('[ok] wrote', outFile)
